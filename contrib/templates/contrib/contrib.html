{% load itfsite_utils %}

{% if not pledge.user and not pledge.execution %}
{# pre-execution, email not confirmed #}
<div class="panel panel-primary">
<div class="panel-heading">
	<h3 class="panel-title" style="font-size: 125%">Next steps</h3>
</div>
<div class="panel-body">
 	<p class="text-danger">We sent you an email. You <strong>must</strong> click the link in the email to confirm your email address before the contribution can be made. The email went to {{pledge.email}}.</p>
 	<hr>

{% elif not pledge.execution %}
{# pre-execution, email confirmed #}
<div class="panel {% if not pledge.user %}panel-default{% else %}panel-success{% endif %}">
<div class="panel-heading">
	<h3 class="panel-title">Thank you</h3>
</div>
<div class="panel-body">

{% elif pledge.execution.problem|stringformat:'s' == 'PledgeExecutionProblem.NoProblem' %}
{# post-execution but problem #}
<div class="panel {% if not pledge.user %}panel-default{% else %}panel-success{% endif %}">
<div class="panel-heading">
	<h3 class="panel-title">Your contribution</h3>
</div>
<div class="panel-body">

{% else %}
{# post-execution (usual case) #}
<div class="panel panel-danger">
<div class="panel-heading">
	<h3 class="panel-title">Your contribution</h3>
</div>
<div class="panel-body">

{% endif %}

{% if not pledge.execution or pledge.execution.problem|stringformat:'s' == 'PledgeExecutionProblem.NoProblem' %}

	<p id="pledge-explanation">You
	{% if pledge.status|stringformat:'s' == 'PledgeStatus.Executed' %}made{% elif pledge.status|stringformat:'s' == 'PledgeStatus.Open' %}have scheduled{% else %}scheduled{% endif %}
	a campaign contribution of
	{% if not execution %}
		${{pledge.amount|floatformat:2}}
	{% else %}
		${{execution.charged|floatformat:2}}
	{% endif %}
	for this {{trigger.trigger_type.strings.action_noun}}.
	It
	{% if pledge.status|stringformat:'s' == 'PledgeStatus.Executed' %}was{% elif pledge.status|stringformat:'s' == 'PledgeStatus.Open' %}will be{% else %}would have been{% endif %}
	split among
	{{pledge.targets_summary}}.
	</p>

	{% if execution and execution.charged < pledge.amount %}
		<p class="small text-muted">Your credit card was charged less than your intended contribution of ${{pledge.amount|floatformat:2}}. We can only make whole-penny contributions to the recipients of your contribution, so we had to round down.</p>
	{% endif %}

	{% if pledge.status|stringformat:'s' == 'PledgeStatus.Open' %}
		<hr>
		{% if pledge.trigger.status|stringformat:'s' == 'TriggerStatus.Open' %}
			<p>Your credit card will not be charged until after the {{trigger.trigger_type.strings.action_noun}} occurs.</p>
			<p style="line-height: 123%"><small>Your credit card may show a $1 temporary authorization from Democracy Engine, LLC, but this authorization will not result in a charge.</small></p>
		{% else %}
			<p>The {{trigger.trigger_type.strings.action_noun}} has occurred, and we are about to process your contribution. You are still able to cancel the contribution before we process it.</p>
		{% endif %}
	{% elif pledge.status|stringformat:'s' == 'PledgeStatus.Vacated' %}
		<p>The event that this contribution was for is no longer expected to occur. Your contribution has been cancelled. Your credit card was not charged.</dd>
	{% endif %}

	{% if pledge.status|stringformat:'s' == 'PledgeStatus.Open' %}
	<p style="text-align: right; margin-bottom: 0"><a href="#" onclick="return cancel_pledge()" class="btn btn-default btn-sm">Cancel Contribution</a></p>
	{% endif %}

	{% if pledge.status|stringformat:'s' == 'PledgeStatus.Executed' and pledge.execution.problem|stringformat:'s' == 'PledgeExecutionProblem.NoProblem' %}
	<p>
		show:
		<a href="#" onclick="$('#my_recipients').fadeToggle(); return false;">{{contribs|length}} recipient{{contribs|length|pluralize}}</a>
		|
		<a href="#" onclick="$('#my-contrib-details').fadeToggle(); return false;">your details</a>
	</p>

	<div id="my_recipients" style="display: none;">
		<table class="table small" style="margin: .5em 0 10px 0">
		<thead>
			<tr><th style="padding-left: 0">Amount</th> <th>Recipient</th></tr>
		</thead>
		<tbody>
		{% for contrib in contribs %}
			<tr><td style="padding-left: 0">${{contrib.amount|floatformat:2}}</td> <td>{{contrib.name_long}}</td></tr>
		{% endfor %}
		</tbody>
		</table>
		<p class="small">Plus {{pledge.execution.fees|currency}} fees.</p>
	</div>
	
	<div id="my-contrib-details" style="display: none">
		<dl>
		<dt>Contributor</dt>
		<dd>
			<p>
				{{pledge.extra.contributor.contribNameFirst}} {{pledge.extra.contributor.contribNameLast}}<br>
				{{pledge.extra.contributor.contribAddress}}<br>
				{{pledge.extra.contributor.contribCity}}, {{pledge.extra.contributor.contribState}} {{pledge.extra.contributor.contribZip}}<br>
				{{pledge.extra.contributor.contribOccupation}} / {{pledge.extra.contributor.contribEmployer}}
			</p>
			<p class="expl">The information above is made available to the candidates receiving your contributions. If you make $200 in contributions to any one candidate in a calendar year, the information also becomes a matter of public record by law.</p>
		</dd>
		</dl>
	</div>
	{% endif %}

  </div>

{% else %}
	<p>{{pledge.execution.problem_text}}</p>

{% endif %}
</div>

{% if not pledge.execution and recommendations|length > 0 %}
<h2 style="margin: 2em 0 0 0">You might be interested in...</h2>
<div class="row">
	{% for t in recommendations %}
		<div class="col-md-4">
			<h3><a href="{{t.get_absolute_url}}" style="border: none">{{t.title}}</a></h3>
			{{t.description|render_text:t.description_format|truncatewords_html:25}}
			<p>{{t.total_pledged|currency}} committed so far</p>
			<p><button onclick="window.location='{{t.get_absolute_url|escapejs}}'" class="btn btn-success">Take Action &raquo;</button></p>
		</div>
	{% endfor %}
</div>
{% endif %}


<script>
function cancel_pledge(desire) {
	show_modal_confirm(
		"Cancel contribution?",
		"Are you sure you want to cancel this contribution?",
		["Cancel Contribution", "Nevermind"],
		function() {
			ajax_with_indicator({
			    url: '/contrib/_cancel',
			    method: "POST",
			    data: { pledge: {{pledge.id}} },
			    success: function(res) {
			      setTimeout("$('#ajax_loading_indicator').fadeIn()", 100);
			      window.location.reload()
			    }
			})
		});
	return false;
}
</script>

